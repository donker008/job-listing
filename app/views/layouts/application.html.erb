<!DOCTYPE html>
<html>
  <head>
    <title>JobListing</title>
    <%= csrf_meta_tags %>

    <%= stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track': 'reload' %>
    <%= javascript_include_tag 'application', 'data-turbolinks-track': 'reload' %>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.2/css/bootstrap-select.min.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.2/js/bootstrap-select.min.js"></script>
    <link rel="shortcut icon" href="images/favicon.ico"/>
  </head>

  <body id="welcomepage">

    <div class="container-fluid">
      <div class="row">
        <%= render "comm/navbar" %>
      </div>
      <%= render "comm/flashs" %>
      <%= yield %>
    </div>
    <%= render "comm/footer" %>

    <script>
    $(document).ready(function(){
      // Add smooth scrolling to all links in navbar + footer link
      $(".navbar a, footer a[href='#welcomepage']").on('click', function(event) {

       // Make sure this.hash has a value before overriding default behavior
      if (this.hash !== "") {

        // Prevent default anchor click behavior
        event.preventDefault();

        // Store hash
        var hash = this.hash;

        // Using jQuery's animate() method to add smooth page scroll
        // The optional number (900) specifies the number of milliseconds it takes to scroll to the specified area
        $('html, body').animate({
          scrollTop: $(hash).offset().top
        }, 900, function(){

          // Add hash (#) to URL when done scrolling (default click behavior)
          window.location.hash = hash;
          });
        } // End if
      });
    });

    $(document).ready(function(){
      $(".filter_part a").on('click', function(event){
          var id = $(this).parent().prop("id");
          var type = parseInt($(this).prop("id"));
          localStorage.setItem(id, type);
          $(this).parent().find("a").removeClass("active");
          $(this).addClass("active");
          // alert("id : " + id + "  type:" + type);
      });

      function updateItemState(objectid, value){
        if(value != 1){
          $(objectid).find("a").each(function (index) {
            $(this).removeClass("active");
            if($(this).prop("id") == value){
              $(this).addClass("active");
              console.log("objectid: " + objectid +  " active" + $(this).toString() + " index : " + (index+1));
            }
          });
        }
        else{
          $(objectid).find("a").first().addClass("active");
          console.log("objectid: " + objectid +  " active" + $(this).toString());
        }

      }

      // update select status
      {
        var place =  localStorage.getItem('place');
        var work_years =  localStorage.getItem('work_years');
        var education =  localStorage.getItem('education');
        var industry =  localStorage.getItem('industry');
        var search = localStorage.getItem('search');


        updateItemState('#place', place);
        updateItemState('#work_years', work_years);
        updateItemState('#education', education);
        updateItemState('#industry', industry);
        if(search == null){
          search = "今日招聘";
        }

        $('#search-input').attr("placeholder",search).val('').focus().blur();

        console.log("place : " + place + " workyears: " + work_years + " education: " + education + " industry: " + industry + " search :" + search);
      }



      $("#job_search").submit(function() {
          var searchword = $(this).parent().find("#search-input").val();
          localStorage.setItem("search", searchword);
          var valuesToSubmit = $(this).serialize();
          //utf8=✓&q[searchjob_cont]=&q[title_cont]=
          valuesToSubmit = decodeURIComponent(valuesToSubmit);
          var place =  localStorage.getItem('place');
          var work_years =  localStorage.getItem('work_years');
          var education =  localStorage.getItem('education');
          var industry =  localStorage.getItem('industry');
          if(parseInt(place) != -1){
            valuesToSubmit += "&q[work_place_eq]="+place;
          }
          if(parseInt(work_years) != -1){
            valuesToSubmit += "&q[work_years_eq]="+work_years;
          }
          if(parseInt(education) != -1){
            valuesToSubmit += "&q[education_eq]="+education;
          }
          if(parseInt(industry) != -1){
            valuesToSubmit += "&q[company_industry_eq]="+industry;
          }
          // alert(valuesToSubmit);

          valuesToSubmit = encodeURLComponent(valuesToSubmit);
          console.log("valuesToSubmit = " + valuesToSubmit);
          $.ajax({
            type: "POST",
            url: $(this).prop('action'),
            data: valuesToSubmit,
            dataType: "JSON"
          }).success(function (json) {
            console.log(json);
             alert(json);
          }).error(function (error) {
            console.log(error);
            // alert(error);
          });
      });
    });

    $('.selectpicker').on('change', function() {
      // <option value="1">不限</option>
      // <option value="2">2 ~ 5k</option>
      // <option value="3">5 ~ 10k</option>
      // <option value="4">10 ~ 20k</option>
      // <option value="5">20 ~ 30k</option>
      // <option value="6">30k以上</option>
      var myurl = "/jobs"
      var value = this.value;
      if(1 != value){
        if(2 == value){
            myurl += "?order=by_salary_2k_5k";
        }
        else if(3 == value){
          myurl += "?order=by_salary_5k_10k";
        }
        else if(4 == value){
          myurl += "?order=by_salary_10k_20k";
        }
        else if(5 == value){
          myurl += "?order=by_salary_20k_30k";
        }
        else if(6 == value){
          myurl += "?order=by_salary_30kabove";
        }
      }
      window.open(myurl,'_self');

      $.ajax(myurl,{
      success: function(data) {
         console.log("success " + data);
          //  $("html").html(data);
           var newDoc = document.open("text/html", "replace");
           newDoc.write(data);
           newDoc.close();
      },
      error: function() {
         console.log('An error occurred');
      }});


    })


    </script>


  </body>



</html>
